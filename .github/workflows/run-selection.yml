name: run-selection

on:
  workflow_dispatch: {}

jobs:
  run-selection:
    runs-on: ubuntu-latest
    # 【重要】ここで環境変数を定義することで、このジョブ内の全ステップでキーが有効になります
    env:
      TZ: Asia/Tokyo
      KEEPA_API_KEY: ${{ secrets.KEEPA_API_KEY }}
      RAKUTEN_APP_ID: ${{ secrets.RAKUTEN_APP_ID }}
      RAKUTEN_SECRET: ${{ secrets.RAKUTEN_SECRET }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure directories exist
        run: |
          mkdir -p scripts
          mkdir -p data

      # 候補作成 (run_selection)
      - name: Run selection logic
        run: |
          python -m scripts.run_selection

      # フィルタリング (filter_asins)
      # ここで APIキーが必要になりますが、上の env で定義済みなので動作します
      - name: Filter ASINs with Keepa/Rakuten
        run: |
          if [ -f "data/output_selected.csv" ]; then
            echo "data/output_selected.csv found. Running filter_asins.py ..."
            # 必要な引数があれば適宜追加してください
            python -m scripts.filter_asins --input data/output_selected.csv --output data/final_list.csv
          else
            echo "No output_selected.csv found, skipping filter step."
          fi

      # 結果の保存
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: selection_results
          path: |
            data/output_selected.csv
            data/final_list.csv
          if-no-files-found: ignore
